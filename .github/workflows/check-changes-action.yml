name: check-for-code-changes
on:
  workflow_call:
    inputs:
      base_ref:
        required: true
        type: string
      file_patterns:
        required: true
        type: string
    outputs:
      code_was_changed:
        value: ${{ jobs.check_changes.outputs.code_was_changed }}
        description: "Whether code was changed"

jobs:
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      code_was_changed: ${{ steps.check_changes.outputs.code_was_changed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # ref: ${{ github.head_ref }}

      - name: Fetch base branch
        run: git fetch origin ${{ github.sha }}

      - name: Check for changes
        run: echo "CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | tr '\n' ',')" >> $GITHUB_ENV

      - name: Check for code changes
        id: check_changes
        run: |
          echo "$CHANGED"
          IFS=',' read -ra ADDR <<< "$CHANGED"
          for i in "${ADDR[@]}"; do
            if [[ $i =~ ${{ inputs.file_patterns }} ]]; then
              echo "code_was_changed=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          done
          echo "code_was_changed=false" >> $GITHUB_OUTPUT

      - name: Code was changed
        run: |
          echo "The code was changed: ${{ steps.check_changes.outputs.code_was_changed }}"
